<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.StoryDao">

    <resultMap id="storyResult" type="com.echoed.chamber.domain.Story">
        <constructor>
            <idArg column="storyId" javaType="String" />
            <arg column="storyUpdatedOn" javaType="_long" />
			<arg column="storyCreatedOn" javaType="_long" />
            <arg column="storyEchoedUserId" javaType="String" />
            <arg column="storyPartnerId" javaType="String" />
            <arg column="storyPartnerHandle" javaType="String" />
            <arg column="storyPartnerSettingsId" javaType="String" />
            <arg resultMap="com.echoed.chamber.dao.ImageDao.imageResult" javaType="com.echoed.chamber.domain.Image" />
            <arg column="storyTitle" javaType="String" />
            <arg column="storyEchoId" javaType="String" />
            <arg column="storyProductId" javaType="String" />
            <arg column="storyProductInfo" javaType="String" />
            <arg column="storyViews" javaType="_int" />
            <arg column="storyComments" javaType="_int" />
        </constructor>
    </resultMap>

    <sql id="storyColumns">
        S.id as storyId,
        S.updatedOn as storyUpdatedOn,
        S.createdOn as storyCreatedOn,
        S.echoedUserId as storyEchoedUserId,
        S.partnerId as storyPartnerId,
        S.partnerHandle as storyPartnerHandle,
        S.partnerSettingsId as storyPartnerSettingsId,
        S.title as storyTitle,
        S.echoId as storyEchoId,
        S.productId as storyProductId,
        S.productInfo as storyProductInfo,
        S.views as storyViews,
        S.comments as storyComments,
        <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
    </sql>

    <select id="findByEchoedUserId" resultMap="storyResult">
        select <include refid="storyColumns" />
        from Story S
        join Image I on S.imageId = I.id
        where S.echoedUserId = #{echoedUserId}
    </select>

    <select id="findByIdAndEchoedUserId" resultMap="storyResult">
        select <include refid="storyColumns" />
        from Story S
        join Image I on S.imageId = I.id
        where S.id = #{id} and S.echoedUserId = #{echoedUserId}
    </select>

    <insert id="insert" parameterType="com.echoed.chamber.domain.Story">
        insert into Story(
            id,
            updatedOn,
            createdOn,
            echoedUserId,
            partnerId,
            partnerHandle,
            partnerSettingsId,
            imageId,
            title,
            echoId,
            productId,
            productInfo
        ) values (
            #{id},
            #{createdOn},
            #{updatedOn},
            #{echoedUserId},
            #{partnerId},
            #{partnerHandle},
            #{partnerSettingsId},
            #{image.id},
            #{title},
            #{echoId},
            #{productId},
            #{productInfo})
    </insert>

    <update id="update">
        update Story set
            imageId = #{image.id},
            title = #{title},
            updatedOn = utc_timestamp() + 0,
            views = #{views},
            comments = #{comments}
    </update>

    <delete id="deleteByEchoedUserId">
        delete from Story where echoedUserId = #{echoedUserId}
    </delete>
</mapper>

