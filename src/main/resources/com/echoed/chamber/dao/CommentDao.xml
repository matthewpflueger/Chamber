<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.CommentDao">

    <resultMap id="commentResult" type="com.echoed.chamber.domain.Comment">
        <constructor>
            <idArg column="commentId" javaType="String" />
            <arg column="commentUpdatedOn" javaType="_long" />
			<arg column="commentCreatedOn" javaType="_long" />
			<arg column="commentStoryId" javaType="String" />
            <arg column="commentEchoedUserId" javaType="String" />
            <arg column="commentPartnerId" javaType="String" />
            <arg column="commentPartnerHandle" javaType="String" />
            <arg column="commentPartnerSettingsId" javaType="String" />
            <arg column="commentEchoId" javaType="String" />
            <arg column="commentChapterId" javaType="String" />
            <arg resultMap="CMTEchoedUserResult" javaType="com.echoed.chamber.domain.EchoedUser"/>
            <arg column="commentParentCommentId" javaType="String" />
            <arg column="commentText" javaType="String" />
        </constructor>
    </resultMap>

    <resultMap id="CMTEchoedUserResult" type="com.echoed.chamber.domain.EchoedUser">
        <constructor>
            <idArg column="CMTEchoedUserId" javaType="String" />
            <arg column="CMTEchoedUserUpdatedOn" javaType="_long" />
            <arg column="CMTEchoedUserCreatedOn" javaType="_long" />
            <arg column="CMTEchoedUserName" javaType="String" />
            <arg column="CMTEchoedUserEmail" javaType="String" />
            <arg column="CMTEchoedUserScreenName" javaType="String" />
            <arg column="CMTEchoedUserFacebookUserId" javaType="String" />
            <arg column="CMTEchoedUserFacebookId" javaType="String" />
            <arg column="CMTEchoedUserTwitterUserId" javaType="String" />
            <arg column="CMTEchoedUserTwitterId" javaType="String" />
            <arg column="CMTEchoedUserPassword" javaType="String" />
            <arg column="CMTEchoedUserSalt" javaType="String" />
        </constructor>
    </resultMap>

    <sql id="commentColumns">
        CMT.id as commentId,
        CMT.updatedOn as commentUpdatedOn,
        CMT.createdOn as commentCreatedOn,
        CMT.storyId as commentStoryId,
        CMT.echoedUserId as commentEchoedUserId,
        CMT.partnerId as commentPartnerId,
        CMT.partnerHandle as commentPartnerHandle,
        CMT.partnerSettingsId as commentPartnerSettingsId,
        CMT.echoId as commentEchoId,
        CMT.chapterId as commentChapterId,
        CMT.parentCommentId as commentParentCommentId,
        CMT.text as commentText,
        <include refid="com.echoed.chamber.dao.CommentDao.CMTEchoedUserColumns"/>
    </sql>

    <sql id="CMTEchoedUserColumns">
        CMTEU.id as CMTEchoedUserId,
        CMTEU.updatedOn as CMTEchoedUserUpdatedOn,
        CMTEU.createdOn as CMTEchoedUserCreatedOn,
        CMTEU.email as CMTEchoedUserEmail,
        CMTEU.name as CMTEchoedUserName,
        CMTEU.screenName as CMTEchoedUserScreenName,
        CMTEU.facebookUserId as CMTEchoedUserFacebookUserId,
        CMTEU.facebookId as CMTEchoedUserFacebookId,
        CMTEU.twitterUserId as CMTEchoedUserTwitterUserId,
        CMTEU.twitterId as CMTEchoedUserTwitterId,
        CMTEU.password as CMTEchoedUserPassword,
        CMTEU.salt as CMTEchoedUserSalt
    </sql>

    <insert id="insert" parameterType="com.echoed.chamber.domain.Comment">
        insert into Comment(
            id,
            updatedOn,
            createdOn,
            storyId,
            echoedUserId,
            partnerId,
            partnerHandle,
            partnerSettingsId,
            echoId,
            chapterId,
            byEchoedUserId,
            parentCommentId,
            text
        ) values (
            #{id},
            #{createdOn},
            #{updatedOn},
            #{storyId},
            #{echoedUserId},
            #{partnerId},
            #{partnerHandle},
            #{partnerSettingsId},
            #{echoId},
            #{chapterId},
            #{echoedUser.id},
            #{parentCommentId},
            #{text})
    </insert>

    <select id="findByStoryId" resultMap="commentResult">
        select <include refid="commentColumns" />
        from Comment CMT
        join EchoedUser CMTEU on CMTEU.id = CMT.byEchoedUserId
        where CMT.storyId = #{storyId}
    </select>

    <select id="findByIdAndChapterId" resultMap="commentResult">
        select <include refid="commentColumns" />
        from Comment CMT
        join EchoedUser CMTEU on CMTEU.id = CMT.byEchoedUserId
        where CMT.id = #{id} and CMT.chapterId = #{chapterId}
    </select>

    <delete id="deleteById">
        delete from Comment where id = #{id}
    </delete>

</mapper>

