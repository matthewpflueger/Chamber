<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.views.FeedDao">

    <cache-ref namespace="com.echoed.chamber.dao.cache.Flushing30" />

    <resultMap id="feedResult" type="com.echoed.chamber.domain.views.Feed">
        <constructor>
            <idArg column="echoedUserId" javaType="String"/>
            <arg javaType="com.echoed.chamber.domain.EchoedUser" resultMap="com.echoed.chamber.dao.EchoedUserDao.echoedUserResult"/>
        </constructor>
        <collection property="echoes" ofType="com.echoed.chamber.domain.views.EchoViewDetail" javaType="ArrayList" resultMap="echoViewResult" />
    </resultMap>

    <resultMap id="echoViewResult" type="com.echoed.chamber.domain.views.EchoViewDetail">
        <constructor>
            <idArg column="echoId" javaType="String" />
            <arg column="echoProductName" javaType="String"/>
            <arg column="echoCategory" javaType="String"/>
            <arg column="echoBrand" javaType="String"/>
            <arg column="echoLandingPageUrl" javaType="String" />
            <arg column="echoedFriendId" javaType="String"/>
            <arg column="echoedFriendName" javaType="String"/>
            <arg column="partnerId" javaType="String" />
            <arg column="partnerName" javaType="String" />
            <arg resultMap="com.echoed.chamber.dao.ImageDao.imageResult" javaType="com.echoed.chamber.domain.Image" />
        </constructor>
    </resultMap>

    <resultMap id="echoViewPublicResult" type="com.echoed.chamber.domain.views.EchoViewPublic">
        <constructor>
            <idArg column="echoId" javaType="String"/>
            <arg column="echoBoughtOn" javaType="Date"/>
            <arg column="echoProductName" javaType="String"/>
            <arg column="echoCategory" javaType="String"/>
            <arg column="echoBrand" javaType="String"/>
            <arg column="echoLandingPageUrl" javaType="String"/>
            <arg column="partnerName" javaType="String"/>
            <arg column="partnerId" javaType="String" />
            <arg column="partnerHandle" javaType="String"/>
            <arg resultMap="com.echoed.chamber.dao.ImageDao.imageResult" javaType="com.echoed.chamber.domain.Image" />
        </constructor>
    </resultMap>

    <select id="getPublicFeed" resultMap="echoViewPublicResult">
        select
            coalesce(E.id) as echoId,
            max(E.createdOn) as echoBoughtOn,
            E.productName as echoProductName,
            coalesce(P.category, "Other") as echoCategory,
            E.brand as echoBrand,
            E.landingPageUrl as echoLandingPageUrl,
            P.name as partnerName,
            P.handle as partnerHandle,
            P.id as partnerId,
            I.id as imageId,
            I.updatedOn as imageUpdatedOn,
            I.createdOn as imageCreatedOn,
            I.url as imageUrl,
            I.originalUrl as imageOriginalUrl,
            I.originalWidth as imageOriginalWidth,
            I.originalHeight as imageOriginalHeight,
            I.sizedUrl as imageSizedUrl,
            I.sizedWidth as imageSizedWidth,
            I.sizedHeight as imageSizedHeight,
            I.thumbnailUrl as imageThumbnailUrl,
            I.thumbnailWidth as imageThumbnailWidth,
            I.thumbnailHeight as imageThumbnailHeight,
            I.processedOn as imageProcessedOn,
            I.processedStatus as imageProcessedStatus,
            I.retries as imageRetries
        from
            Echo E
            join Image I on E.imageId = I.id
            join Partner P on E.partnerId = P.id
            join EchoMetrics EM on EM.echoId = E.id
            join PartnerSettings PS on PS.id=EM.partnerSettingsId
        where
            I.sizedWidth > 0
            and
            PS.activeOn &lt;= Now()
        group by
            echoProductName,
            echoBrand,
            echoLandingPageUrl,
            partnerName,
            imageId,
            imageOriginalUrl,
            imageSizedUrl,
            imageSizedWidth,
            imageThumbnailUrl,
            imageThumbnailWidth,
            imageThumbnailHeight,
            imageProcessedOn,
            imageProcessedStatus,
            imageRetries
        order by
            echoBoughtOn desc
        limit
            #{start}, #{limit}
    </select>

    <select id="getCategoryFeed"  resultMap="echoViewPublicResult">
        select
        E.id as echoId,
        E.createdOn as echoBoughtOn,
        E.productName as echoProductName,
        coalesce(P.category,"Other") as echoCategory,
        E.brand as echoBrand,
        E.landingPageUrl as echoLandingPageUrl,
        P.name as partnerName,
        P.id as partnerId,
        P.handle as partnerHandle,
        <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from
        Echo E
        join Image I on E.imageId = I.id
        join Partner P on E.partnerId = P.id
        where
        P.category = #{categoryId}
        order by
        E.createdOn desc, E.id DESC
        Limit
        #{start}, #{limit}
    </select>


    <select id="getPartnerFeed"  resultMap="echoViewPublicResult">
        select
            E.id as echoId,
            E.createdOn as echoBoughtOn,
            E.productName as echoProductName,
            coalesce(P.category,"Other") as echoCategory,
            E.brand as echoBrand,
            E.landingPageUrl as echoLandingPageUrl,
            P.name as partnerName,
            P.id as partnerId,
            P.handle as partnerHandle,
            <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from
            Echo E
            join Image I on E.imageId = I.id
            join Partner P on E.partnerId = P.id
        where
            P.handle = #{partnerId}
            or
            P.id = #{partnerId}
        order by
            E.createdOn desc, E.id DESC
        Limit
            #{start}, #{limit}
    </select>

    <select id="getEchoedUserFeed"  resultMap="echoViewPublicResult">
        select
        E.id as echoId,
        E.createdOn as echoBoughtOn,
        E.productName as echoProductName,
        coalesce(P.category,"Other") as echoCategory,
        E.brand as echoBrand,
        E.landingPageUrl as echoLandingPageUrl,
        P.name as partnerName,
        P.id as partnerId,
        P.handle as partnerHandle,
        <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from
        Echo E
        join Image I on E.imageId = I.id
        join Partner P on E.partnerId = P.id
        where
        E.echoedUserId = #{echoedUserId}
        order by
        E.createdOn desc, E.id DESC
        Limit
        #{start}, #{limit}
    </select>

    <select id="findByEchoedUserId" resultMap="feedResult">
        select
            <include refid="com.echoed.chamber.dao.EchoedUserDao.echoedUserColumns" />
            EU2.id as echoedFriendId,
            EU2.name as echoedFriendName,
            EU2.screenName as echoedFriendScreenName,
            E.id as echoId,
            E.boughtOn as echoBoughtOn,
            E.productName as echoProductName,
            P.category as echoCategory,
            E.brand as echoBrand,
            coalesce(E.price, 0)  as echoPrice,
            E.landingPageUrl as echoLandingPageUrl,
            coalesce(EM.totalClicks, 0) as echoTotalClicks,
            ROUND(coalesce(EM.credit, 0),2) as echoCredit,
            P.id as partnerId,
            P.name as partnerName,
            PS.id as partnerSettingsId,
            coalesce(PS.minClicks, 0) as partnerSettingsMinClicks,
            coalesce(PS.minPercentage, 0) as partnerSettingsMinPercentage,
            coalesce(PS.maxPercentage, 0) as partnerSettingsMaxPercentage,
            FP.id as facebookPostId,
            FP.facebookId as facebookPostFacebookId,
            TS.id as twitterStatusId,
            TS.twitterId as twitterStatusTwitterId,
            <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from
            EchoedUser EU
            left outer join EchoedFriend EF on EU.id = EF.fromEchoedUserId
            left outer join EchoedUser EU2 on EF.toEchoedUserId = EU2.id
            left outer join Echo E on EF.toEchoedUserId = E.echoedUserId
            left outer join Image I on E.imageId = I.id
            left outer join EchoMetrics EM on E.id = EM.echoId
            left outer join Partner P on E.partnerId = P.id
            left outer join PartnerSettings PS on E.partnerSettingsId = PS.id
            left outer join FacebookPost FP on E.facebookPostId = FP.id
            left outer join TwitterStatus TS on E.twitterStatusId = TS.id
        where
            EU.id = #{id} and I.sizedWidth > 0
        order by
            E.createdOn desc, E.id DESC
        limit
            #{start},#{limit}
    </select>

    <resultMap id="storyFullResult" type="com.echoed.chamber.domain.views.StoryFull">
        <constructor>
            <idArg column="id" javaType="String"/>
            <arg javaType="com.echoed.chamber.domain.Story" resultMap="com.echoed.chamber.dao.StoryDao.storyResult" />
            <arg javaType="com.echoed.chamber.domain.EchoedUser" resultMap="com.echoed.chamber.dao.EchoedUserDao.echoedUserResult" />
        </constructor>
        <collection
                property="chapters"
                ofType="com.echoed.chamber.domain.Chapter"
                javaType="ArrayList"
                resultMap="com.echoed.chamber.dao.ChapterDao.chapterResult" />
        <collection
                property="chapterImages"
                ofType="com.echoed.chamber.domain.ChapterImage"
                javaType="ArrayList"
                resultMap="com.echoed.chamber.dao.ChapterImageDao.chapterImageResult" />
        <collection
                property="comments"
                ofType="com.echoed.chamber.domain.Comment"
                javaType="ArrayList"
                resultMap="com.echoed.chamber.dao.CommentDao.commentResult" />
    </resultMap>

    <sql id="storyFullSelect">
        select
            S.id as id,
            <include refid="com.echoed.chamber.dao.StoryDao.storyColumns" />,
            <include refid="com.echoed.chamber.dao.EchoedUserDao.echoedUserColumns" />,
            <include refid="com.echoed.chamber.dao.ChapterDao.chapterColumns" />,
            <include refid="com.echoed.chamber.dao.ChapterImageDao.chapterImageColumns" />,
            <include refid="com.echoed.chamber.dao.CommentDao.commentColumns" />
            from Story S
                join EchoedUser EU on S.echoedUserId = EU.id
                join Image I on S.imageId = I.id
                left outer join Chapter C on S.id = C.storyId
                left outer join ChapterImage CI on S.id = CI.storyId
                left outer join Image CIMG on CI.imageId = CIMG.id
                left outer join Comment CMT on S.id = CMT.storyId
                left outer join EchoedUser CMTEU on CMT.byEchoedUserId = CMTEU.id
    </sql>

    <select id="findStoryByEchoedUserId" resultMap="storyFullResult" useCache = "false">
        <include refid="storyFullSelect" />
        where EU.id=#{echoedUserId}
        order by
            S.createdOn desc,
            C.createdOn,
            CIMG.createdOn,
            CMT.createdOn desc
    </select>

    <select id="findStoryByPartnerId" resultMap="storyFullResult">
        <include refid="storyFullSelect" />
        where
            S.partnerId=#{partnerId}
        order by
            S.createdOn desc,
            C.createdOn,
            CIMG.createdOn,
            CMT.createdOn desc
    </select>

    <select id="findStoryById" resultMap="storyFullResult" useCache = "false">
        <include refid="storyFullSelect" />
        where S.id = #{storyId}
        order by
            C.createdOn,
            CIMG.createdOn,
            CMT.createdOn desc
    </select>

    <select id="findStoryByEchoId" resultMap="storyFullResult" useCache="false">
        <include refid="storyFullSelect" />
        where S.echoId = #{echoId}
        order by
            C.createdOn,
            CIMG.createdOn,
            CMT.createdOn desc
    </select>

    <select id="getStories" resultMap="storyFullResult" useCache="false">
        <include refid="storyFullSelect" />
        order by
            S.createdOn desc,
            C.createdOn,
            CIMG.createdOn,
            CMT.createdOn desc
    </select>

    <select id="getStoryIds" resultType="String">
        select S.id from Story S join Chapter C on S.id = C.storyId order by C.createdOn desc
    </select>

    <select id="getPartnerIds" resultType="String">
        select coalesce(handle, id) from Partner order by createdOn desc
    </select>

</mapper>
