<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.views.RetailerViewDao">

    <cache-ref namespace="com.echoed.chamber.dao.cache.Flushing30" />

    <resultMap id="retailerSocialSummaryResult" type="com.echoed.chamber.domain.views.RetailerSocialSummary">
        <constructor>
            <idArg column="retailerId" javaType="String"/>
            <arg column="retailerName" javaType="String" />
            <arg column="totalEchoes" javaType="_int" />
            <arg column="totalFacebookLikes" javaType="_int" />
            <arg column="totalFacebookComments" javaType="_int" />
            <arg column="totalEchoClicks" javaType="_int"/>
        </constructor>
    </resultMap>

    <resultMap id="retailerProductsListView" type="com.echoed.chamber.domain.views.RetailerProductsListView">
        <constructor>
            <idArg column="retailerId" javaType="String"/>
            <arg column="retailerName" javaType="String"/>
        </constructor>
        <collection property="products" ofType="com.echoed.chamber.domain.views.ProductSocialSummary" javaType="ArrayList" resultMap="productSocialSummaryResult"/>
    </resultMap>

    <resultMap id="productSocialSummaryResult" type="com.echoed.chamber.domain.views.ProductSocialSummary">
        <constructor>
            <idArg column="productId" javaType="String" />
            <arg column="productName" javaType="String" />
            <arg column="productBrand" javaType="String" />
            <arg column="productCategory" javaType="String" />
            <arg column="retailerId" javaType="String" />
            <arg column="retailerName" javaType="String" />
            <arg column="productImageUrl" javaType="String" />
            <arg column="totalEchoes" javaType="_int" />
            <arg column="totalFacebookLikes" javaType="_int" />
            <arg column="totalFacebookComments" javaType="_int" />
            <arg column="totalEchoClicks" javaType="_int"/>
        </constructor>
    </resultMap>

    <resultMap id="retailerCustomerListView" type="com.echoed.chamber.domain.views.RetailerCustomerListView">
        <constructor>
            <idArg column="retailerId" javaType="String"/>
            <arg column="retailerName" javaType="String"/>
        </constructor>
        <collection property="customers" ofType="com.echoed.chamber.domain.views.CustomerSocialSummary" javaType="ArrayList" resultMap="customerSocialSummaryResult"/>
    </resultMap>

    <resultMap id="customerSocialSummaryResult" type="com.echoed.chamber.domain.views.CustomerSocialSummary">
        <constructor>
            <idArg column="echoedUserId" javaType="String" />
            <arg column="echoedUserName" javaType="String"/>
            <arg column="totalEchoes" javaType="_int" />
            <arg column="totalFacebookLikes" javaType="_int" />
            <arg column="totalFacebookComments" javaType="_int" />
            <arg column="totalEchoClicks" javaType="_int"/>
            <arg column="totalFacebookFriends" javaType="_int"/>
        </constructor>
    </resultMap>

    <sql id="productColumns">
        E.productId as productId,
        coalesce (E.productName) as productName,
        coalesce (E.brand) as productBrand,
        coalesce (E.category) as productCategory,
        coalesce (R.id) as retailerId,
        coalesce (R.name) as retailerName,
        coalesce(E.imageUrl) as productImageUrl,
        count(E.id) as totalEchoes,
        coalesce(sum(ESA.facebookLikes), 0) as totalFacebookLikes,
        coalesce(sum(ESA.facebookComments), 0) as totalFacebookComments,
        coalesce(sum(ESA.echoClicks), 0) as totalEchoClicks
    </sql>

    <sql id="aggregateSalesByRetailerIdAndProductId">
        (
            SELECT
                EP.productId as productId
                EP.retailerId as retailerId
                sum(EP.price) as totalSales
            GROUP BY
                EP.productId,
                EP.retailerId
        )
    </sql>

    <sql id="aggregateStatsByEcho">
        (
            SELECT
                E.id as echoId,
                count(FBL.likes) as facebookLikes,
                count(FBC.comments) as facebookComments,
                count(EC.echoClicks) as echoClicks
            FROM
                Echo E
                LEFT OUTER JOIN
                FacebookPost FBP ON FBP.echoId = E.id
                LEFT OUTER JOIN
                (
                    SELECT
                        facebookPostId,
                        count(id) as likes
                    FROM
                        FacebookLike
                    GROUP BY
                        facebookPostId
                )
                FBL ON FBL.facebookPostId = FBP.id
                LEFT OUTER JOIN
                (
                    SELECT
                        facebookPostId,
                        count(id) as comments
                    FROM
                        FacebookComment
                    GROUP BY
                        facebookPostId
                )
                FBC ON FBC.facebookPostId = FBP.id
                LEFT OUTER JOIN
                (
                    SELECT
                        echoId,
                        count(id) as echoClicks
                    FROM
                        EchoClick
                    GROUP BY
                        echoId
                )
                EC ON E.id = EC.echoId
            GROUP BY
                E.id
        )
    </sql>

    <sql id="friendsAggregate">
        (
            SELECT
                FacebookUser.echoedUserId,
                count(FacebookFriend.id) as facebookFriends
            FROM
                FacebookUser
                LEFT OUTER JOIN
                FacebookFriend ON FacebookUser.id = FacebookFriend.facebookUserId
            GROUP BY
                FacebookUser.echoedUserId
        )
    </sql>


    <select id="getTopProductsWithRetailerId" resultMap="retailerProductsListView">
        SELECT <include refid="productColumns" />
        FROM
            Retailer R
            LEFT OUTER JOIN
            Echo E ON R.id = E.retailerId
            LEFT OUTER JOIN
            <include refid="aggregateStatsByEcho" />
            ESA ON E.id=ESA.echoId
        WHERE
            R.id = #{retailerId}
        GROUP BY
            R.id, R.name, E.productId, E.productName, E.brand, E.category
        ORDER BY
            totalEchoes DESC
        LIMIT
            0, 5
    </select>

    <select id="getProductsWithRetailerId" resultMap="retailerProductsListView">
        SELECT
            <include refid="productColumns"/>
        FROM
            Retailer R
            LEFT OUTER JOIN
            Echo E On R.id = E.retailerId
            LEFT OUTER JOIN
            <include refid = "aggregateStatsByEcho" />
        ESA ON E.id=ESA.echoId
        WHERE
            R.id = #{retailerId}
        GROUP BY
            R.id, R.name, E.productId, E.productName, E.brand, E.category
        ORDER BY
            totalEchoes DESC
    </select>

    <select id="getSocialActivityByProductIdAndRetailerId" resultMap="productSocialSummaryResult">
        SELECT <include refid="productColumns" />
        FROM
            Retailer R
            LEFT OUTER JOIN
            Echo E ON R.id = E.retailerId
            LEFT OUTER JOIN
            <include refid="aggregateStatsByEcho" />
            ESA on E.id=ESA.echoId
        WHERE
            R.id = #{retailerId}
            AND
            E.productId = #{productId}
        GROUP BY
            R.id, R.name, E.productId, E.productName
    </select>

    <select id="getTopCustomersWithRetailerId" resultMap="retailerCustomerListView" >
        SELECT
            R.id as retailerId,
            R.name as retailerName,
            EU.id as echoedUserId,
            EU.name as echoedUserName,
            count(E.id) as totalEchoes,
            coalesce(sum(ESA.facebookLikes), 0) as totalFacebookLikes,
            coalesce(sum(ESA.facebookComments), 0) as totalFacebookComments,
            coalesce(sum(ESA.echoClicks), 0) as totalEchoClicks,
            coalesce(FF.facebookFriends, 0) as totalFacebookFriends
         FROM
            Retailer R
            LEFT OUTER JOIN
            Echo E ON R.id = E.retailerId
            LEFT OUTER JOIN
            EchoedUser EU ON  E.echoedUserId = EU.id
            LEFT OUTER JOIN
            <include refid="aggregateStatsByEcho" />
            ESA ON E.id = ESA.echoId
            LEFT OUTER JOIN
            <include refid="friendsAggregate" />
            FF ON FF.echoedUserId=EU.id
        WHERE
            R.id = #{retailerId}
        GROUP BY
            R.id, R.name, EU.id, EU.name
        LIMIT
            0,5
    </select>

    <select id="getSocialActivityByRetailerId" resultMap="retailerSocialSummaryResult">
       SELECT
            R.id as retailerId,
            R.name as retailerName,
            count(E.id) as totalEchoes,
            coalesce(sum(ESA.facebookLikes), 0) as totalFacebookLikes,
            coalesce(sum(ESA.facebookComments), 0) as totalFacebookComments,
            coalesce(sum(ESA.echoClicks), 0) as totalEchoClicks
        FROM
            Retailer R
            LEFT OUTER JOIN
            Echo E ON R.id = E.retailerId
            LEFT OUTER JOIN
            <include refid="aggregateStatsByEcho"/>
            ESA ON E.id = ESA.echoId
        WHERE
            R.id = #{retailerId}
        GROUP BY
            R.id, R.name
    </select>

</mapper>
