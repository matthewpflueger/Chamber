<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.views.ClosetDao">

    <cache-ref namespace="com.echoed.chamber.dao.cache.Flushing30" />

    <resultMap id="closetResult" type="com.echoed.chamber.domain.views.Closet">
        <constructor>
            <idArg column="echoedUserId" javaType="String" />
            <arg javaType="com.echoed.chamber.domain.EchoedUser" resultMap="echoedUserResult" />
        </constructor>
        <collection property="echoes" ofType="com.echoed.chamber.domain.views.EchoView" javaType="ArrayList" resultMap="echoViewResult" />
    </resultMap>

    <resultMap id="echoedUserResult" type="com.echoed.chamber.domain.EchoedUser">
        <constructor>
            <idArg column="echoedUserId" javaType="String" />
            <arg column="echoedUserName" javaType="String" />
			<arg column="echoedUserEmail" javaType="String" />
            <arg column="echoedUserScreenName" javaType="String" />
            <arg column="echoedUserFacebookUserId" javaType="String" />
            <arg column="echoedUserFacebookId" javaType="String" />
            <arg column="echoedUserTwitterUserId" javaType="String" />
            <arg column="echoedUserTwitterId" javaType="String" />
        </constructor>
    </resultMap>

    <resultMap id="echoViewResult" type="com.echoed.chamber.domain.views.EchoView">
        <constructor>
            <idArg column="echoId" javaType="String" />
            <arg column="echoBoughtOn" javaType="Date" />
            <arg column="echoProductName" javaType="String"/>
            <arg column="echoCategory" javaType="String"/>
            <arg column="echoBrand" javaType="String"/>
            <arg column="echoPrice" javaType="_float" />
            <arg column="echoLandingPageUrl" javaType="String" />
            <arg column="echoTotalClicks" javaType="_int" />
            <arg column="echoCredit" javaType="_float" />
            <arg column="echoCreditWindowEndsAt" javaType="Date"/>
            <arg column="partnerId" javaType="String" />
            <arg column="partnerName" javaType="String" />
            <arg column="partnerHandle" javaType="String" />
            <arg column="partnerSettingsId" javaType="String" />
            <arg column="partnerSettingsMinClicks" javaType="_int" />
            <arg column="partnerSettingsMinPercentage" javaType="_float" />
            <arg column="partnerSettingsMaxPercentage" javaType="_float" />
            <arg column="facebookPostId" javaType="String" />
            <arg column="facebookPostFacebookId" javaType="String" />
            <arg column="twitterStatusId" javaType="String" />
            <arg column="twitterStatusTwitterId" javaType="String" />
            <arg resultMap="com.echoed.chamber.dao.ImageDao.imageResult" javaType="com.echoed.chamber.domain.Image" />
        </constructor>
    </resultMap>

    <select id="findByEchoedUserId" resultMap="closetResult" useCache="false" >
        select
            EU.id as echoedUserId,
            EU.email as echoedUserEmail,
            EU.name as echoedUserName,
            EU.screenName as echoedUserScreenName,
            EU.facebookUserId as echoedUserFacebookUserId,
            EU.facebookId as echoedUserFacebookId,
            EU.twitterUserId as echoedUserTwitterUserId,
            EU.twitterId as echoedUserTwitterId,
            E.id as echoId,
            E.boughtOn as echoBoughtOn,
            E.productName as echoProductName,
            P.category as echoCategory,
            E.brand as echoBrand,
            coalesce(E.price, 0)  as echoPrice,
            E.landingPageUrl as echoLandingPageUrl,
            coalesce(EM.totalClicks, 0) as echoTotalClicks,
            ROUND(coalesce(EM.credit, 0),2) as echoCredit,
            EM.creditWindowEndsAt as echoCreditWindowEndsAt,
            P.id as partnerId,
            P.name as partnerName,
            P.handle as partnerHandle,
            PS.id as partnerSettingsId,
            coalesce(PS.minClicks, 0) as partnerSettingsMinClicks,
            coalesce(PS.minPercentage, 0) as partnerSettingsMinPercentage,
            coalesce(PS.maxPercentage, 0) as partnerSettingsMaxPercentage,
            FP.id as facebookPostId,
            FP.facebookId as facebookPostFacebookId,
            TS.id as twitterStatusId,
            TS.twitterId as twitterStatusTwitterId,
            <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from EchoedUser EU
            left outer join Echo E on EU.id = E.echoedUserId
            left outer join Image I on E.imageId = I.id
            left outer join EchoMetrics EM on E.id = EM.echoId
            left outer join Partner P on E.partnerId = P.id
            left outer join PartnerSettings PS on E.partnerSettingsId = PS.id
            left outer join FacebookPost FP on E.facebookPostId = FP.id
            left outer join TwitterStatus TS on E.twitterStatusId = TS.id
        where EU.id = #{id}
        ORDER BY
            E.createdOn DESC
        LIMIT
            #{start}, #{limit}
    </select>


    <select id="totalCreditByEchoedUserId" resultType="_float" useCache="false" >
        select coalesce(sum(credit), 0) as totalCredit from EchoMetrics where echoedUserId = #{echoedUserId}
    </select>

    <select id="totalClicksByEchoedUserId" resultType="_int" useCache="false">
        select coalesce(sum(totalClicks), 0) as totalClicks from EchoMetrics where echoedUserId = #{echoedUserId}
    </select>
</mapper>
