<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.echoed.chamber.dao.EchoDao">

    <cache-ref namespace="com.echoed.chamber.dao.cache.Default" />

    <resultMap id="orderResult" type="com.echoed.chamber.domain.Order">
        <constructor>
            <idArg column="id" javaType="String" />
            <arg column="updatedOn" javaType="Date" />
            <arg column="createdOn" javaType="Date" />
            <arg column="customerId" javaType="String" />
            <arg column="boughtOn" javaType="Date" />
            <arg column="orderId" javaType="String" />
        </constructor>
    </resultMap>

    <resultMap id="productResult" type="com.echoed.chamber.domain.Product">
        <constructor>
            <idArg column="id" javaType="String" />
            <arg column="updatedOn" javaType="Date" />
            <arg column="createdOn" javaType="Date" />
            <arg column="productId" javaType="String" />
            <arg column="price" javaType="_float" />
            <arg column="landingPageUrl" javaType="String" />
            <arg column="productName" javaType="String"/>
            <arg column="category" javaType="String"/>
            <arg column="brand" javaType="String"/>
            <arg column="description" javaType="String"/>
        </constructor>
    </resultMap>

    <resultMap id="echoResult" type="com.echoed.chamber.domain.Echo">
        <constructor>
            <idArg column="id" javaType="String" />
            <arg column="updatedOn" javaType="Date" />
            <arg column="createdOn" javaType="Date" />
            <arg column="retailerId" javaType="String" />
            <arg column="echoedUserId" javaType="String" />
            <arg column="facebookPostId" javaType="String" />
            <arg column="twitterStatusId" javaType="String"/>
            <arg column="echoPossibilityId" javaType="String" />
            <arg column="retailerSettingsId" javaType="String" />
            <arg column="echoMetricsId" javaType="String" />
            <arg column="echoClickId" javaType="String" />
            <arg column="step" javaType="String" />
            <arg resultMap="orderResult" javaType="com.echoed.chamber.domain.Order" />
            <arg resultMap="productResult" javaType="com.echoed.chamber.domain.Product" />
            <arg resultMap="com.echoed.chamber.dao.ImageDao.imageResult" javaType="com.echoed.chamber.domain.Image" />
        </constructor>
    </resultMap>


    <sql id="echoSelect">
        select
            E.*,
            <include refid="com.echoed.chamber.dao.ImageDao.imageColumns" />
        from Echo E
        join Image I on E.imageId = I.id
    </sql>

    <select id="findById" resultMap="echoResult">
        <include refid="echoSelect" />
        where E.id = #{id}
    </select>

    <select id="findByEchoPossibilityId" resultMap="echoResult">
        <include refid="echoSelect" />
        where E.echoPossibilityId = #{echoPossibilityId}
    </select>

    <select id="findByIdOrEchoPossibilityId" resultMap="echoResult">
        <include refid="echoSelect" />
        where E.id = #{id} or E.echoPossibilityId = #{id}
    </select>

    <select id="findByIdOrEchoPossibilityId" resultMap="echoResult">
        select * from Echo where id = #{id} or echoPossibilityId = #{id}
    </select>

    <select id="findByRetailerId" resultMap="echoResult">
        <include refid="echoSelect" />
    	where E.retailerId = #{retailerId}
    </select>

    <select id="selectCount" resultType="long" useCache="false" >
        select count(*) from Echo
    </select>


    <insert id="insert" parameterType="com.echoed.chamber.domain.Echo">
    	insert into Echo(
    			id,
    			createdOn,
                retailerId,
                customerId,
                productId,
                boughtOn,
                orderId,
                price,
                echoedUserId,
                facebookPostId,
                echoPossibilityId,
                landingPageUrl,
                retailerSettingsId,
                productName,
                category,
                brand,
                description,
                echoClickId,
                step,
                imageUrl,
                echoMetricsId,
                imageId)
        values (
                #{id},
                #{createdOn},
                #{retailerId},
                #{order.customerId},
                #{product.productId},
                #{order.boughtOn},
                #{order.orderId},
                #{product.price},
                #{echoedUserId},
                #{facebookPostId},
                #{echoPossibilityId},
                #{product.landingPageUrl},
                #{retailerSettingsId},
                #{product.productName},
                #{product.category},
                #{product.brand},
                #{product.description},
                #{echoClickId},
                #{step},
                #{image.url},
                #{echoMetricsId},
                #{image.id})
    </insert>

    <update id="updateForStep" parameterType="com.echoed.chamber.domain.Echo">
        update Echo set
            step = #{step}
        where
            id = #{id}
    </update>

    <update id="updateForEcho" parameterType="com.echoed.chamber.domain.Echo">
        update Echo set
            step = #{step},
            echoedUserId = #{echoedUserId}
        where
            id = #{id}
    </update>

    <update id="updateFacebookPostId" parameterType="com.echoed.chamber.domain.Echo">
        update Echo set
            facebookPostId = #{facebookPostId}
        where
            id = #{id}
    </update>

    <update id="updateTwitterStatusId" parameterType="com.echoed.chamber.domain.Echo">
        update Echo set
            twitterStatusId = #{twitterStatusId}
        where
            id = #{id}
    </update>

    <delete id="deleteByEchoPossibilityId">
        delete from Echo where echoPossibilityId = #{echoPossibilityId}
    </delete>

    <delete id="deleteByRetailerId">
        delete from Echo where retailerId = #{retailerId}
    </delete>

    <delete id="deleteById">
        delete from Echo where id = #{id}
    </delete>

</mapper>
