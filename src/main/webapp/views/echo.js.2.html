    function ___getPageSize() {
        var xScroll, yScroll;
        if (window.innerHeight && window.scrollMaxY) {
            xScroll = window.innerWidth + window.scrollMaxX;
            yScroll = window.innerHeight + window.scrollMaxY;
        } else if (document.body.scrollHeight > document.body.offsetHeight) { // all but Explorer Mac
            xScroll = document.body.scrollWidth;
            yScroll = document.body.scrollHeight;
        } else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
            xScroll = document.body.offsetWidth;
            yScroll = document.body.offsetHeight;
        }
        var windowWidth, windowHeight;
        if (self.innerHeight) {    // all except Explorer
            if (document.documentElement.clientWidth) {
                windowWidth = document.documentElement.clientWidth;
            } else {
                windowWidth = self.innerWidth;
            }
            windowHeight = self.innerHeight;
        } else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
            windowWidth = document.documentElement.clientWidth;
            windowHeight = document.documentElement.clientHeight;
        } else if (document.body) { // other Explorers
            windowWidth = document.body.clientWidth;
            windowHeight = document.body.clientHeight;
        }
// for small pages with total height less then height of the viewport
        if (yScroll < windowHeight) {
            pageHeight = windowHeight;
        } else {
            pageHeight = yScroll;
        }
// for small pages with total width less then width of the viewport
        if (xScroll < windowWidth) {
            pageWidth = xScroll;
        } else {
            pageWidth = windowWidth;
        }
        arrayPageSize = new Array(pageWidth, pageHeight, windowWidth, windowHeight);
        return arrayPageSize;
    }

    function EchoedActivateNetwork(e){
        Echoed[e] = true;
        $('.echoed-cb[network^=' + e + ']').each(function(){
            $(this).attr("checked", "checked");
        });
    }

    function EchoedPostMessageInterface(str){
        window.setTimeout(function() {
            window.top.postMessage(str);
        }, 0 );
    }

    function EchoedDeactivateNetwork(e){
        Echoed[e] = false;
        $('.echoed-cb[network^=' + e + ']').each(function(){
            $(this).removeAttr("checked");
        });
    }

    function EchoedSetName(e){
        var li = $('<div class="echoed-li">You are logged into Echoed as: ' + e +  ' (<span class="echoed-not echoed-highlight">Not ' + e + '?</span>)</div>')
        li.hide().prependTo($('#echoed-l-i-c')).slideDown();
    }

    function EchoedLogout(){
        $('.echoed-li').slideUp(function(){ $(this).remove() });
        Echoed.name = "";
        EchoedDeactivate();
        EchoedDeactivateNetwork('facebook');
        EchoedDeactivateNetwork('twitter');
    }

    function EchoedDeactivate(){
        $('.echoed-l').removeClass('on');
    }

    function EchoedActivate(){

        $('.echoed-l').addClass('on');
    }

    function receiveMessageResponse(e){
        var data = JSON.parse(e.data);
        if(data.name){
            EchoedSetName(data.name);
            EchoedActivate();
        }
        if(data.facebook){
            EchoedActivateNetwork("facebook");
        }
        if(data.twitter){
            EchoedActivateNetwork("twitter");
        }
    }

    function loadJSInclude(scriptPath, callback){
        var scriptNode = document.createElement("script");
        scriptNode.type ="text/javascript";
        scriptNode.src = scriptPath;
        var head = document.getElementsByTagName('HEAD')[0];
        head.appendChild(scriptNode);
        if(callback != null) {
            scriptNode.onload = callback;
        }
    }

    if(typeof jQuery == 'undefined'){
        loadJSInclude('https://c779203.ssl.cf2.rackcdn.com/jquery-1.6.2.min.js', function(){
            $(function(){
                echoedPrompt();
            });
        });
    } else {
        echoedPrompt();
    }

    function echoedPrompt(){

        if(window.addEventListener){
            window.addEventListener('message', receiveMessageResponse , false);
        } else if (window.attachEvent) {
            window.attachEvent('onmessage', receiveMessageResponse);
        }

        Echoed = {};
        Echoed.urls = {}; //{{#urls}}
        Echoed.urls.api = "{{api}}";
        Echoed.urls.cdn = "{{cdn}}";
        Echoed.urls.js = "{{js}}";
        Echoed.urls.css = "{{css}}";
        Echoed.urls.images = "{{images}}";
        Echoed.urls.views = "{{views}}";
        Echoed.urls.site = "{{site}}";
        Echoed.facebook = false;
        Echoed.twitter = false;
        Echoed.name = "";
        /*{{/urls}} // */

        var arrPageSizes = ___getPageSize();

        var cssNode = document.createElement("link");
        cssNode.type="text/css";
        cssNode.rel = "stylesheet";
        cssNode.href = "{{urls.css}}/echoed-lightbox.2.css";
        document.getElementsByTagName('HEAD')[0].appendChild(cssNode);

        var fontNode = document.createElement("link");
        fontNode.type= "text/css";
        fontNode.rel = "stylesheet";
        fontNode.href= "https://fonts.gooogleapis.com/css?family=Lato:400,700";
        document.getElementsByTagName('HEAD')[0].appendChild(fontNode);

        var body = document.getElementsByTagName('BODY')[0];

        var fadeNode = document.createElement("div");
        fadeNode.id = "echoed-fade";
        body.insertBefore(fadeNode, body.firstChild);

        fadeNode.style.height= arrPageSizes[1] + "px";
        fadeNode.style.width = arrPageSizes[0] + "px";

        var popupNode = document.createElement("div");
        popupNode.id = "echoed-popup";

        var iFrameNode = document.createElement('iframe');
        iFrameNode.height = "0px";
        iFrameNode.width = "0px";
        iFrameNode.style.border = "none";
        iFrameNode.id = "echoed-iframe";
        iFrameNode.src = "{{urls.site}}/echo/iframe";
        popupNode.appendChild(iFrameNode);

        var closeImg = document.createElement("img");
        closeImg.src = "{{urls.images}}/btn_close_x.png";
        closeImg.id= "echoed-close";
        popupNode.appendChild(closeImg);

        var header = document.createElement("div");
        header.id = "echoed-header";
        popupNode.appendChild(header);

        var headerImg = document.createElement("img");
        headerImg.src = "{{logo}}";
        headerImg.id = "echoed-h-l";
        header.appendChild(headerImg);

        var container = document.createElement("div");
        container.id = "echoed-container";
        popupNode.appendChild(container);

        var hiwt = document.createElement("div");
        hiwt.id = "echoed-hiw-t";
        hiwt.innerHTML = 'Thank You For Your Order';
        container.appendChild(hiwt);

        var hiwtt = document.createElement("div");
        hiwtt.id = "echoed-hiw-tt";
        popupNode.appendChild(hiwtt);

        var pcc = document.createElement("div");
        pcc.id = "echoed-pcc";
        container.appendChild(pcc);

        var pc = document.createElement("div");
        pc.id = "echoed-p-c";
        pc.className = "clearfix";
        pcc.appendChild(pc);

        body.appendChild(popupNode);

        $('#echoed-hiw-tt').append("<strong>Save up to {{maxPercentage}}% on each item you share with friends!<br/>Each friend that checks out what you've shared contributes to your reward.</strong><br/><br/><span class='echoed-highlight'>1.</span> Customize your message <span class='echoed-highlight'> 2. </span> Select your network(s) <span class='echoed-highlight'> 3. </span> Click the share button<br/>Your savings are automatically applied back to your credit card.");

        var container = $('#echoed-p-c');
        var table = $('<table><thead><tr><th align="left" colspan="1" width="100px"><img align="absmiddle" src="{{urls.images}}/bk_shopping_cart.png"/>Your Cart</th><th colspan="3" valign="bottom"><div id="echoed-l-i-c"></div></th></tr></thead></table>');
        var tbody = $('<tbody></tbody>');
        table.append(tbody);
        $.ajax({
            url:Echoed.urls.api + "/echo/request",
            dataType:'jsonp',
            data:{
                "pid":"{{pid}}",
                "data":echoData,
                "view":"{{view}}"
            },
            success:function (data) {
                container.append(table);
                $(data.echoPossibilities).each(function (index, echoPossibility) {
                    echoPossibility.boughtOn = new Date(echoPossibility.boughtOn).toUTCString();
                    var message = "";
                    var placeHolder = "Tell your friends why you bought this product and save up to {{maxPercentage}}% when your friends click through";
                    var t1 = $('<tr><td class="echoed-tdspan" colspan="4"><div><strong>' + echoPossibility.productName + '</strong> $' + echoPossibility.price + '</div></td></tr>');
                    var t2 =  $('<tr valign="middle" class="echoed-p"><td class="echoed-td1" valign="middle"><div class="echoed-i-c"><img class="echoed-i" src="' + echoPossibility.imageUrl + '" /></div></td><td class="echoed-td2" valign="middle"><textarea id="' + echoPossibility.id +  '-ta" placeholder="' + placeHolder + '">' + message + '</textarea></td><td class="echoed-td3"><img height="25px" align="absmiddle" src="{{urls.images}}/btn_sq_clr_fb.png"/><input id="' + echoPossibility.id + '-facebook" class="echoed-cb" echoPossibilityId="' + echoPossibility.id + '" network="facebook" type="checkbox" name="option1"/><span class="echoed-td-t"> Share With Facebook</span><br/><img height="25px" align="absmiddle" src="{{urls.images}}/btn_sq_clr_tw.png"/><input id="' + echoPossibility.id + '-twitter" class="echoed-cb" echoPossibilityId="' + echoPossibility.id + '" network="twitter" type="checkbox" name="option1"/><span class="echoed-td-t"> Share With Twitter</span></td><td class="echoed-td4" valign="middle"><span id=' + echoPossibility.id + ' class="echoed-l" href="' + Echoed.urls.api + '/echo/login?id=' + echoPossibility.id + '"></span></td></tr>');
                    tbody.append(t1);
                    tbody.append(t2);
                });
            }
        });

        $('.echoed-l').live('click', function(){
            var self = $(this);
            var echoId = self.attr("id");
            if(self.hasClass('on')){

                var textarea = $('#' + echoId + '-ta');
                var tac = textarea.parent();
                var message = textarea.val();

                if(message.length > 0){
                    var overlay = $('<img src="{{urls.images}}/flower-loader.gif" />');
                    self.parent().append(overlay);
                    self.hide();
                    var echoId = self.attr("id");
                    var postToFacebook = $('#' + echoId + '-facebook').is(":checked");
                    var postToTwitter = $('#' + echoId + '-twitter').is(":checked");
                    var row = self.parent().parent();
                    $.ajax({
                        type: 'GET',
                        url: Echoed.urls.api + "/echo/finishjson",
                        dataType: 'jsonp',
                        data :{
                            message: message,
                            postToFacebook: postToFacebook,
                            postToTwitter: postToTwitter,
                            echoId: echoId
                        },
                        success: function(data){
                            overlay.remove();
                            textarea.remove();
                            row.find('.echoed-td3').remove();
                            row.find('.echoed-td4').remove();
                            row.find('.echoed-td2').css("font-size","14px").attr("colspan","3");
                            row.find(".echoed-td-t").remove();
                            tac.append("<strong>You've successfully shared with Echoed!</strong> As your friends click, comment and like the link you've shared, your reward will grow. <br/><br/>Track the rewards you've earned on <a target='_blank' href='{{urls.site}}/#exhibit' class='echoed-highlight'>Echoed.com</a>");
                        }
                    });
                } else {
                    alert('Please enter a message to share with friends');
                }
            } else {
                alert('Please select a network to share this product on');
            }
        });

        $('.echoed-not').live('click', function(){
            EchoedLogout();
        });

        $('.echoed-cb').live('click', function () {
            if(!$(this).is(':checked')){
                $(this).removeAttr('checked');
            } else {
                if(!Echoed[$(this).attr("network")]){
                    var echoedAuthorizeURL = "{{urls.site}}/echo/authorize?close=true&id=" + $(this).attr("echoPossibilityId") + "&network=" + $(this).attr("network");
                    var child = window.open("about:blank", "Echoed",'width=800,height=440,toolbar=0,menubar=0,location=0,status=1,scrollbars=0,resizable=0,left=0,top=0');
                    child.location = echoedAuthorizeURL;
                    var iFrame = document.getElementById("echoed-iframe");
                    iFrame.src = "{{https.site}}/echo/iframe";
                    return false;
                }
            }
        });

        $('#echoed-close').live('click', function () {
            $('#echoed-fade,#echoed-popup').hide();
        });
    };

