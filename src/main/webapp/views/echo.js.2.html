    function ___getPageSize() {
        var xScroll, yScroll;
        if (window.innerHeight && window.scrollMaxY) {
            xScroll = window.innerWidth + window.scrollMaxX;
            yScroll = window.innerHeight + window.scrollMaxY;
        } else if (document.body.scrollHeight > document.body.offsetHeight) { // all but Explorer Mac
            xScroll = document.body.scrollWidth;
            yScroll = document.body.scrollHeight;
        } else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
            xScroll = document.body.offsetWidth;
            yScroll = document.body.offsetHeight;
        }
        var windowWidth, windowHeight;
        if (self.innerHeight) {    // all except Explorer
            if (document.documentElement.clientWidth) {
                windowWidth = document.documentElement.clientWidth;
            } else {
                windowWidth = self.innerWidth;
            }
            windowHeight = self.innerHeight;
        } else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
            windowWidth = document.documentElement.clientWidth;
            windowHeight = document.documentElement.clientHeight;
        } else if (document.body) { // other Explorers
            windowWidth = document.body.clientWidth;
            windowHeight = document.body.clientHeight;
        }
// for small pages with total height less then height of the viewport
        if (yScroll < windowHeight) {
            pageHeight = windowHeight;
        } else {
            pageHeight = yScroll;
        }
// for small pages with total width less then width of the viewport
        if (xScroll < windowWidth) {
            pageWidth = xScroll;
        } else {
            pageWidth = windowWidth;
        }
        arrayPageSize = new Array(pageWidth, pageHeight, windowWidth, windowHeight);
        return arrayPageSize;
    }

    function EchoedActivateNetwork(e){
        Echoed[e] = true;
        $('.echoed-cb[network^=' + e + ']').each(function(){
            $(this).attr("checked", "checked");
        });
    }

    function EchoedDeactivateNetwork(e){
        Echoed[e] = false;
        $('.echoed-cb[network^=' + e + ']').each(function(){
            $(this).removeAttr("checked");
        });
    }

    function EchoedSetName(e){
        var li = $('<div class="echoed-li">You are logged into Echoed as: ' + e +  ' (<span class="echoed-not echoed-highlight">Not ' + e + '?</span>)</div>')
        li.hide().prependTo($('#echoed-l-i-c')).slideDown();
    }

    function EchoedLogout(){
        $('.echoed-li').slideUp(function(){ $(this).remove() });
        Echoed.name = "";
        EchoedDeactivate();
        EchoedDeactivateNetwork('facebook');
        EchoedDeactivateNetwork('twitter');
    }

    function EchoedDeactivate(){
        $('.echoed-l').removeClass('on');
    }

    function EchoedActivate(){

        $('.echoed-l').addClass('on');
    }

    function receiveMessageResponse(e){
        if(e.data.name){
            EchoedSetName(e.data.name);
            EchoedActivate();
        }
        if(e.data.facebook){
            EchoedActivateNetwork("facebook");
        }
        if(e.data.twitter){
            EchoedActivateNetwork("twitter");
        }
    }


    function loadJSInclude(scriptPath, callback){
        var scriptNode = document.createElement("script");
        scriptNode.type ="text/javascript";
        scriptNode.src = scriptPath;
        var head = document.getElementsByTagName('HEAD')[0];
        head.appendChild(scriptNode);
        if(callback != null) {
            scriptNode.onreadystatechange = callback;
            scriptNode.onload = callback;
        }
    }

    if(typeof jQuery == 'undefined'){
        loadJSInclude('https://c779203.ssl.cf2.rackcdn.com/damnit.js?811d70b87140025bfe3845b1f8a13773608017dc', function(){
            ApplicationError.config({prompt_user: false});
            loadJSInclude('https://c779203.ssl.cf2.rackcdn.com/jquery-1.6.2.min.js', function(){
                try {
                    echoedPrompt();
                } catch(e) {
                    ApplicationError.notify(e.stack);
                }
            });
        });
    } else {
        try {
            echoedPrompt();
        } catch(e) {
            ApplicationError.notify(e.stack);
        }
    }

    function echoedPrompt(){
        var css = $('<link rel="stylesheet" type="text/css" href="{{urls.css}}/echoed-lightbox.2.css" />');
        $('body').append(css);

        Echoed = {};
        Echoed.urls = {}; //{{#urls}}
        Echoed.urls.api = "{{api}}";
        Echoed.urls.cdn = "{{cdn}}";
        Echoed.urls.js = "{{js}}";
        Echoed.urls.css = "{{css}}";
        Echoed.urls.images = "{{images}}";
        Echoed.urls.views = "{{views}}";
        Echoed.urls.site = "{{site}}";
        Echoed.facebook = false;
        Echoed.twitter = false;
        Echoed.name = "";
        /*{{/urls}} // */

        var arrPageSizes = ___getPageSize();

        $('body').prepend('<div id="echoed-fade"></div>');
        $('head').append($("<link href='http://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>"));

        $('#echoed-fade').css({
            width:arrPageSizes[0],
            height:arrPageSizes[1]
        });

        var popup = $('<div id="echoed-popup"><img src="{{urls.images}}/btn_close_x.png" id="echoed-close"/><div id="echoed-header">{{#partner}}<img id="echoed-h-l" src="{{logo}}"/ >{{/partner}}</div><div id="echoed-container"><div id="echoed-hiw-t"></div><div id="echoed-pcc"><div id="echoed-p-c" class="clearfix"></div></div><div id="echoed-hiw-tt"></div></div></div>');
        popup.appendTo($('body')).fadeIn();
        $('#echoed-hiw-t').html('Thank You For Your Order');
        $('#echoed-hiw-tt').append("<strong>Save up to {{maxPercentage}}% on each item you share with friends!<br/>Each friend that checks out what you've shared contributes to your reward.</strong><br/><br/>");
        $('#echoed-hiw-tt').append("<span class='echoed-highlight'>1.</span> Customize a message for your social network(s) <span class='echoed-highlight'>2.</span> Select your network(s) <span class='echoed-highlight'> 3.</span> Click the share button<br/>");
        $('#echoed-hiw-tt').append("Your savings are automatically applied back to your credit card.");
        var container = $('#echoed-p-c');
        var table = $('<table><thead><tr><th align="left" colspan="1" width="100px"><img align="absmiddle" src="{{urls.images}}/bk_shopping_cart.png"/>Your Cart</th><th colspan="3" valign="bottom"><div id="echoed-l-i-c"></div></th></tr></thead></table>');
        var tbody = $('<tbody></tbody>');
        table.append(tbody);
        $.ajax({
            url:Echoed.urls.api + "/echo/request",
            dataType:'jsonp',
            data:{
                "pid":"{{pid}}",
                "data":echoData,
                "view":"{{view}}"
            },
            success:function (data) {
                container.append(table);
                $(data.echoPossibilities).each(function (index, echoPossibility) {
                    echoPossibility.boughtOn = new Date(echoPossibility.boughtOn).toUTCString();
                    var message = "";
                    var placeHolder = "Tell your friends why you bought this product and save up to {{maxPercentage}}% when your friends click through";
                    var t1 = $('<tr><td colspan="4"><div><strong>' + echoPossibility.productName + '</strong> ($' + echoPossibility.price + ')</td></tr>');
                    var t2 =  $('<tr valign="middle" class="echoed-p"><td class="echoed-td1" valign="middle"><div class="echoed-i-c"><img class="echoed-i" src="' + echoPossibility.imageUrl + '" /></div></td><td class="echoed-td2" valign="middle"><textarea id="' + echoPossibility.id +  '-ta" placeholder="' + placeHolder + '">' + message + '</textarea></td><td class="echoed-td3"><img height="25px" align="absmiddle" src="{{urls.images}}/btn_sq_clr_fb.png"/><input id="' + echoPossibility.id + '-facebook" class="echoed-cb" echoPossibilityId="' + echoPossibility.id + '" network="facebook" type="checkbox" name="option1"/><span class="echoed-td-t">Share With Facebook</span><br/><img height="25px" align="absmiddle" src="{{urls.images}}/btn_sq_clr_tw.png"/><input id="' + echoPossibility.id + '-twitter" class="echoed-cb" echoPossibilityId="' + echoPossibility.id + '" network="twitter" type="checkbox" name="option1"/><span class="echoed-td-t">Share With Twitter</span></td><td class="echoed-td4" valign="middle"><span id=' + echoPossibility.id + ' class="echoed-l" href="' + Echoed.urls.api + '/echo/login?id=' + echoPossibility.id + '"></span></a></td></tr>');
                    tbody.append(t1);
                    tbody.append(t2);
                });
            }
        });

        $('.echoed-l').live('click', function(){
            var self = $(this);
            var echoId = self.attr("id");
            if(self.hasClass('on')){
                var textarea = $('#' + echoId + '-ta');
                var tac = textarea.parent();
                var message = textarea.val();

                if(message.length > 0){
                    var overlay = $('<img src="{{urls.images}}/flower-loader.gif" />');
                    self.parent().append(overlay);
                    self.hide();
                    var echoId = self.attr("id");
                    var postToFacebook = $('#' + echoId + '-facebook').is(":checked");
                    var postToTwitter = $('#' + echoId + '-twitter').is(":checked");
                    var row = self.parent().parent();
                    $.ajax({
                        type: 'GET',
                        url: Echoed.urls.api + "/echo/finishjson",
                        dataType: 'jsonp',
                        data :{
                            message: message,
                            postToFacebook: postToFacebook,
                            postToTwitter: postToTwitter,
                            echoId: echoId
                        },
                        success: function(data){
                            overlay.remove();
                            textarea.remove();
                            row.find('.echoed-td3').remove();
                            row.find('.echoed-td4').remove();
                            row.find('.echoed-td2').css("font-size","14px").attr("colspan","3");
                            row.find(".echoed-td-t").remove();
                            tac.append("<strong>You've successfully shared with Echoed!</strong> As your friends click, comment and like the link you've shared, your reward will grow. <br/><br/>Track the rewards you've earned on <a target='_blank' href='{{urls.site}}/#exhibit' class='echoed-highlight'>Echoed.com</a>");
                        }
                    });
                } else {
                    alert('Please enter a message to share with friends');
                }
            } else {
                alert('Please select a network to share this product on');
            }
        });

        $('.echoed-not').live('click', function(){
            EchoedLogout();
        });

        $('.echoed-cb').live('click', function () {
            if(!$(this).is(':checked')){
                $(this).removeAttr('checked');
            } else {
                if(!Echoed[$(this).attr("network")]){
                    var echoedAuthorizeURL = "{{urls.site}}/echo/authorize?close=true&id=" + $(this).attr("echoPossibilityId") + "&network=" + $(this).attr("network");
                    window.addEventListener('message', receiveMessageResponse , false);
                    window.open(echoedAuthorizeURL, "Echoed",'width=800,height=440,toolbar=0,menubar=0,location=0,status=1,scrollbars=0,resizable=0,left=0,top=0');
                    return false;
                }
            }
        });

        $('#echoed-close').live('click', function () {
            $('#echoed-fade,#echoed-popup').hide();
        });
    };

