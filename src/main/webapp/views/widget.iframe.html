<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="{{urls.css}}/echoed-widget.css"/>
    <script type='text/javascript' src="{{urls.js}}/webfonts.js"></script>
    <script type='text/javascript' src="{{urls.js}}/jquery-1.6.2.min.js"></script>
    <script type='text/javascript' src="{{urls.js}}/json2.js"></script>
    <script type='text/javascript' src="{{urls.js}}/underscore-min.js"></script>
    <script type='text/javascript' src="{{urls.js}}/backbone-0.9.1-min.js"></script>
    <script type='text/javascript' src="{{urls.js}}/jquery.isotope.min.js"></script>
</head>
<body>
<div id="echoed-story"></div>
<div id="echoed-exhibit-container">
    <div class='echoed-close'><img src='{{urls.images}}/btn_close_x_black.png'/></div>

    <div class='echoed-head'>
        {{#title}}
            {{.}}
        {{/title}}
        {{^title}}
            Real Stories From Our Customers
        {{/title}}
    </div>
    <div id='echoed-e-c-b'>
        <div id='echoed-exhibit'></div>
    </div>
    <div class='echoed-footer clearfix'>
        <div class='echoed-footer-left'></div>
        <div class='echoed-footer-right'>
            <div class='echoed-share-container'><a class='echoed-share' target='_blank' href='{{urls.site}}/#write/partner/{{partnerId}}'>Share Your Story</a></div>
            <div><img src='{{urls.images}}/bk_widget_subtitle.png'/></div>
        </div>
    </div>
</div>
</div>
</body>
</html>

<script type="text/javascript">
Echoed = {
    Views:{
        Pages:{},
        Components:{}
    },
    Urls:{
        Api:"{{urls.api}}",
        Css:"{{urls.css}}",
        Site:"{{urls.site}}"
    },
    Models:{},
    Collections:{},
    timeStampStringToDate:function (timestampString) {
        var year = timestampString.substr(0, 4);
        var month = timestampString.substr(4, 2);
        var day = timestampString.substr(6, 2);
        var hour = timestampString.substr(8, 2);
        var minute = timestampString.substr(10, 2);
        var second = timestampString.substr(12, 2);
        var date = new Date(Date.UTC(year, month - 1, day, hour, minute, second, 0));
        return date;
    },
    timeElapsedString:function (date) {
        var responseString = "";
        var todayDate = new Date();
        var dateDiff = todayDate - date;
        var dayDiff = Math.floor((dateDiff) / (1000 * 60 * 60 * 24));
        var hourDiff = Math.floor((dateDiff) / (1000 * 60 * 60));
        var minDiff = Math.floor((dateDiff) / (1000 * 60));
        if (dayDiff >= 1) {
            responseString = dayDiff + " day" + Echoed.pluralize(dayDiff);
        } else if (hourDiff >= 1) {
            responseString = hourDiff + " hour" + Echoed.pluralize(hourDiff);
        } else {
            responseString = minDiff + " minute" + Echoed.pluralize(minDiff);
        }
        responseString = responseString + " ago";
        return responseString;
    },
    pluralize:function (integer) {
        if (integer >= 2) {
            return "s";
        } else {
            return "";
        }
    },
    getImageSizing:function (image, width) {
        return {
            height:image.preferredHeight / image.preferredWidth * width,
            width:width
        }
    },
    getProfilePhotoUrl:function (echoedUser) {
        if (echoedUser.facebookId !== null) {
            return "http://graph.facebook.com/" + echoedUser.facebookId + "/picture";
        } else if (echoedUser.twitterId !== null) {
            return "http://api.twitter.com/1/users/profile_image/" + echoedUser.twitterId;
        }
        return "";
    },
    getFacebookLoginUrl:function (hash) {
        return Echoed.facebookLogin.head +
                encodeURIComponent(Echoed.facebookLogin.redirect + encodeURIComponent(hash)) +
                Echoed.facebookLogin.tail;
    },
    getTwitterLoginUrl:function (hash) {
        return Echoed.twitterUrl + encodeURIComponent(hash);
    },
    facebookLogin : {
        head: "https://www.facebook.com/dialog/oauth?client_id={{facebookClientId}}&redirect_uri=",
        redirect : "{{https.site}}/facebook/login?redirect=",
        tail: "&scope=email,user_birthday,publish_actions"
    },
    twitterUrl : "{{urls.site}}/twitter?redirect=",
    init:function (options) {
        this.partnerId = options.partnerId;
        this.echoedUser = options.echoedUser;
        var exhibit = new Echoed.Views.Pages.Exhibit({ el:'#echoed-exhibit-container', EvAg:EventAggregator });
        var infiniteScroll = new Echoed.Views.Components.InfiniteScroll({ el:'#echoed-infiniteScroll', EvAg:EventAggregator});
        var story = new Echoed.Views.Components.Story({ el:'#echoed-story', EvAg:EventAggregator });
        var fade = new Echoed.Views.Components.Fade({ el:'#echoed-fade', EvAg:EventAggregator });
        var iFrameComm = new Echoed.Views.Components.MessageHandler({ el:'#echoed-iframe', EvAg:EventAggregator });
        var router = new Echoed.Router({ EvAg:EventAggregator });
    }
};
Echoed.Router = Backbone.Router.extend({
    initialize:function (options) {
    },
    routes:{
    }
});

Echoed.Views.Components.Opener = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'open');
        this.EvAg = options.EvAg;
        this.el = options.el;
        this.element = $(this.el);
    },
    events:{
        "click":"open"
    },
    open:function () {
        var self = this;
        self.EvAg.trigger('exhibit/open');
    }
});

Echoed.Views.Components.Fade = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'show', 'hide');
        this.EvAg = options.EvAg;
        this.el = options.el;
        this.element = $(this.el);
        this.EvAg.bind("fade/show", this.show);
        this.EvAg.bind("fade/hide", this.hide);
    },
    show:function () {
        var self = this;
        var arrPageSizes = self.___getPageSize();
        $("html,body").addClass("noScroll");
        self.element.fadeIn();
    },
    hide:function () {
        var self = this;
        self.element.fadeOut();
        $("html,body").removeClass("noScroll");
        window.setTimeout(function(){
            window.top.postMessage("close","*");
        }, 0);
    },
    ___getPageSize:function () {
        var xScroll, yScroll;
        if (window.innerHeight && window.scrollMaxY) {
            xScroll = window.innerWidth + window.scrollMaxX;
            yScroll = window.innerHeight + window.scrollMaxY;
        } else if (document.body.scrollHeight > document.body.offsetHeight) { // all but Explorer Mac
            xScroll = document.body.scrollWidth;
            yScroll = document.body.scrollHeight;
        } else { // Explorer Mac...would also work in Explorer 6 Strict, Mozilla and Safari
            xScroll = document.body.offsetWidth;
            yScroll = document.body.offsetHeight;
        }
        var windowWidth, windowHeight;
        if (self.innerHeight) {    // all except Explorer
            if (document.documentElement.clientWidth) {
                windowWidth = document.documentElement.clientWidth;
            } else {
                windowWidth = self.innerWidth;
            }
            windowHeight = self.innerHeight;
        } else if (document.documentElement && document.documentElement.clientHeight) { // Explorer 6 Strict Mode
            windowWidth = document.documentElement.clientWidth;
            windowHeight = document.documentElement.clientHeight;
        } else if (document.body) { // other Explorers
            windowWidth = document.body.clientWidth;
            windowHeight = document.body.clientHeight;
        }
        // for small pages with total height less then height of the viewport
        if (yScroll < windowHeight) {
            pageHeight = windowHeight;
        } else {
            pageHeight = yScroll;
        }
        // for small pages with total width less then width of the viewport
        if (xScroll < windowWidth) {
            pageWidth = xScroll;
        } else {
            pageWidth = windowWidth;
        }
        arrayPageSize = new Array(pageWidth, pageHeight, windowWidth, windowHeight);
        return arrayPageSize;
    }
});

Echoed.Views.Components.InfiniteScroll = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'triggerScroll', 'lock', 'unlock', 'on', 'off');
        this.EvAg = options.EvAg;
        this.EvAg.bind("triggerInfiniteScroll", this.triggerScroll);
        this.EvAg.bind("infiniteScroll/lock", this.lock);
        this.EvAg.bind("infiniteScroll/unlock", this.unlock);
        this.EvAg.bind("infiniteScroll/on", this.on);
        this.EvAg.bind("infiniteScroll/off", this.off);

        this.element = $('<div id="echoed-infiniteScroll">Loading </div>');
        $('#echoed-e-c-b').append(this.element);
        this.locked = false;
        var self = this;
        this.status = true;
        $('#echoed-e-c-b').scroll(function () {
            if ($('#echoed-e-c-b').scrollTop() >= $('#echoed-exhibit').height() - $('#echoed-e-c-b').height() && self.locked == false && self.status == true) {
                self.EvAg.trigger("infiniteScroll");
            }
        });
    },
    on:function () {
        var self = this;
        self.status = true;
    },
    off:function () {
        var self = this;
        self.status = false;
        self.element.hide();
    },
    lock:function () {
        var self = this;
        self.element.show();
        self.locked = true
    },
    unlock:function () {
        var self = this;
        self.element.hide();
        self.locked = false;
        if ($('#echoed-e-c-b').scrollTop() >= $('#echoed-exhibit').height() - $('#echoed-e-c-b').height() && self.locked == false && self.status == true) {
            self.EvAg.trigger("infiniteScroll");
        }
    },
    triggerScroll:function () {
        var self = this;
        var noVScroll = $(document).height() <= $(window).height();
        if (noVScroll) {
            self.EvAg.trigger('infiniteScroll');
        }
    }

});


Echoed.Models.Product = Backbone.Model.extend({
    initialize:function () {
    }
});

Echoed.Views.Pages.Exhibit = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'render', 'next', 'init', 'show', 'hide', 'close', 'nextStory', 'previousStory');
        this.EvAg = options.EvAg;
        this.el = options.el;
        this.EvAg.bind('exhibit/open', this.init);
        this.EvAg.bind('infiniteScroll', this.next);
        this.EvAg.bind("exhibit/show", this.show);
        this.EvAg.bind("exhibit/hide", this.hide);
        this.EvAg.bind('exhibit/story/next', this.nextStory);
        this.EvAg.bind('exhibit/story/previous', this.previousStory);
        this.element = $(this.el);
        this.exhibit = $('#echoed-exhibit');
        this.jsonUrl = Echoed.Urls.Api + "/api/partner/" + Echoed.partnerId;
        this.element.find('.echoed-footer-left').prepend($('<div class="echoed-footer-left-text"></div>').html("Let us know about your experience and we'll publish your story right here for everyone to see!"));
        this.element.find('.echoed-footer-left').prepend($('<div class="echoed-footer-left-title"></div>').html("Got a great story to tell?"));
        this.nextInt = 1;
    },
    events:{
        "click .echoed-close":"close"
    },
    nextStory:function (storyId) {
        var self = this;
        var index = self.stories.hash[storyId];
        console.log(self.stories);
        if ((index + 1) >= self.stories.array.length) {
            self.next();
        }
        if ((index + 1) < self.stories.array.length) {
            self.EvAg.trigger('story/show', self.stories.array[index + 1]);
        }
    },
    previousStory:function (storyId) {
        var self = this;
        var index = self.stories.hash[storyId];
        console.log(self.stories);
        if (index > 0) {
            self.EvAg.trigger('story/show', self.stories.array[index - 1]);
        }
    },
    close:function () {
        this.EvAg.trigger('fade/hide');
    },
    show:function (callback) {
        var self = this;
        this.element.fadeIn(function () {
            self.EvAg.trigger('infiniteScroll/on');
        });
    },
    hide:function (callback) {
        this.EvAg.trigger('infiniteScroll/off');
        this.element.fadeOut();
    },
    init:function () {
        var self = this;
        self.nextInt = 1;
        self.EvAg.trigger('infiniteScroll/on');
        self.exhibit.isotope({
            itemSelector:'.item_wrap,.no_filter',
            masonry:{
                columnWidth:5
            }
        });
        self.EvAg.trigger('infiniteScroll/lock');
        $.ajax({
            url:self.jsonUrl,
            xhrFields:{
                withCredentials:true
            },
            dataType:'jsonp',
            success:function (data) {
                self.stories = {
                    array:[],
                    hash:{}
                };
                self.render(data);
            }
        });
        self.element.fadeIn();
        self.EvAg.trigger('fade/show');
    },
    render:function (data) {
        var self = this;
        if (data.stories) {
            self.addStories(data);
            self.nextInt++;
            self.EvAg.trigger("infiniteScroll/unlock");
        }
    },
    next:function () {
        var self = this;
        if (self.nextInt != null) {
            self.EvAg.trigger('infiniteScroll/lock');
            $.ajax({
                url:self.jsonUrl + "?page=" + (self.nextInt - 1) + "&origin=widget",
                xhrFields:{
                    withCredentials:true
                },
                dataType:'jsonp',
                success:function (data) {
                    if (data.stories.length > 0) {
                        self.addStories(data);
                        self.nextInt++;
                        self.EvAg.trigger("infiniteScroll/unlock");
                    } else {
                        self.nextInt = null;
                        self.EvAg.trigger("infiniteScroll/off");
                    }
                }
            });
        }
    },
    addStories:function (data) {
        var self = this;
        var storiesFragment = $('<div></div>');
        $.each(data.stories, function (index, story) {
            if (story.chapters.length > 0) {
                self.stories.hash[story.id] = self.stories.array.length;
                self.stories.array.push(story.id);
                var storyDiv = $('<div></div>').addClass('item_wrap');
                var storyComponent = new Echoed.Views.Components.StoryBrief({el:storyDiv, data:story, EvAg:self.EvAg});
                storiesFragment.append(storyDiv);
            }
        });
        self.exhibit.isotope('insert', storiesFragment.children());
    }
});


Echoed.Views.Components.StoryBrief = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'render', 'click', 'hideOverlay', 'showOverlay');
        this.el = options.el;
        this.element = $(this.el);
        this.EvAg = options.EvAg;
        this.data = options.data;
        this.render();
    },
    events:{
        "click .story-brief-overlay":"click",
        "mouseenter .story-brief-image-container":"showOverlay",
        "mouseleave .story-brief-image-container":"hideOverlay"
    },
    render:function () {
        var self = this;
        var template = '<div class="item_content">' +
                '<div class="story-brief">' +
                '<div class="story-brief-image-container">' +
                '<div class="story-brief-overlay" style="display:none;">' +
                '<div class="story-brief-overlay-wrap">' +
                '</div>' +
                '</div>' +
                '<img class="story-brief-image" src= ""/>' +
                '</div>' +
                '<div class="story-brief-text"></div>' +
                '</div>' +
                '</div>';
        self.element.html(template);
        var imageNode = self.element.find(".story-brief-image");
        var textNode = self.element.find(".story-brief-text");
        var overlayNode = self.element.find(".story-brief-overlay-wrap");
        var image = self.data.story.image;

        imageNode.attr("src", image.sizedUrl).css(Echoed.getImageSizing(image, 228));
        overlayNode.html(self.data.story.title);
        textNode.append($("<div class='story-brief-text-title'></div>").append(self.data.story.title));
        textNode.append($("<div class='story-brief-text-by'></div>").append("Story by <a class='story-brief-text-user' target='_blank' href='" + Echoed.Urls.Site + "#user/" + self.data.echoedUser.id + "'>" + self.data.echoedUser.name + "</a>"));

        textNode.append($("<img class='story-brief-text-user-image' height='35px' width='35px' align='absmiddle'/>").attr("src", Echoed.getProfilePhotoUrl(self.data.echoedUser)).css({"margin":5 }));
        var chapterText = self.data.chapters[0].text;
        var c = chapterText.split(/[.!?]/)[0];
        c = c + chapterText.substr(c.length, 1); //Append Split Character


        textNode.prepend($("<div class='story-brief-text-quote'></div>").html('"' + c + '"'));
        var indicators = $("<div class='story-brief-indicator'></div>");
        indicators.append($("<span class='story-brief-indicator-sprite'></span>").addClass('sprite-comment'));
        indicators.append($("<span class='story-brief-indicator-value'></span>").append(self.data.comments.length));
        indicators.append($("<span class='story-brief-indicator-sprite'></span>").addClass('sprite-photo'));
        indicators.append($("<span class='story-brief-indicator-value'></span>").append(self.data.chapterImages.length + 1));
        textNode.append(indicators);
        self.element.attr("id", self.data.story.id);
    },
    showOverlay:function () {
        var self = this;
        self.element.find(".story-brief-overlay").fadeIn();
    },
    hideOverlay:function () {
        var self = this;
        self.element.find(".story-brief-overlay").fadeOut();
    },
    click:function () {
        var self = this;
        var id = self.element.attr("id");
        self.EvAg.trigger('story/show', id);
        this.EvAg.trigger('exhibit/hide');
    }
});

Echoed.Views.Components.Story = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'render', 'load', 'createComment', 'renderImage', 'imageClick', 'nextImage', 'navClick', 'commentLogin', 'login');
        this.el = options.el;
        this.element = $(this.el);
        this.EvAg = options.EvAg;
        this.EvAg.bind('story/show', this.load);
        this.EvAg.bind('story/hide', this.unload);
        this.EvAg.bind('user/login', this.login);
    },
    events:{
        "click .echoed-close":"close",
        "click .comment-submit":"createComment",
        "click .login-button":"commentLogin",
        "click .echo-s-b-thumbnail":"imageClick",
        "click .echo-s-b-item":"nextImage",
        "click .story-nav-button":"navClick"
    },
    login:function () {
        var self = this;
        this.element.find('.comment-login').fadeOut(function () {
            self.element.find('.comment-submit').fadeIn();
        });
    },
    navClick:function (ev) {
        var self = this;
        var target = $(ev.currentTarget);
        var action = target.attr("act");
        self.EvAg.trigger('exhibit/story/' + action, self.data.story.id);
    },
    unload:function () {
        var self = this;
        self.element.fadeOut();
    },
    load:function (id) {
        var self = this;
        $.ajax({
            url:Echoed.Urls.Api + "/api/story/" + id + "?origin=widget",
            type:"GET",
            dataType:'jsonp',
            xhrFields:{
                withCredentials:true
            },
            success:function (data) {
                self.data = data;
                self.render();
            }
        });
    },
    render:function () {

        var template = '<div id="echo-story-nav" class="clearfix"><div act="previous" class="story-nav-button" style="float:left">Previous Story</div><div act="next" class="story-nav-button" style="float:right">Next Story</div></div><div class="echo-story-container clearfix"><div class="echoed-close"><img src="{{urls.images}}/btn_close_x_black.png"/></div><div class="echo-story-header clearfix"><div class="echo-s-h-title clearfix"> <div class="echo-s-h-i-c"> <img class="echo-s-h-i-i" src="" /> </div> <div class="echo-s-h-t-t"> </div> <div class="echo-s-h-t-n"></div></div></div><div class="echo-story-main"><div class="echo-story-body clearfix"> <div class="echo-s-b-text"></div><div class="echo-s-b-gallery clearfix"></div></div> <div class="echo-story-footer clearfix"> <div class="echo-story-comments"> <div class="echo-s-c-t">Discussion <span id="echo-s-c-t-count"></span> </div> <div class="echo-s-c-ta"> <textarea id="echo-story-comment-ta"></textarea></div><div class="echo-s-c-tb"><div class="comment-submit">Submit Comment</div></div><div class="echo-s-c-l"></div></div></div></div><div id="echo-story-gallery" class="echo-story-gallery"></div></div>';
        var self = this;
        self.element.html(template);

        self.chapters = {
            array:[],
            hash:{}
        };

        $.each(self.data.chapters, function (index, chapter) {
            var hash = {
                chapter:chapter,
                images:[]
            };
            if (index === 0) {
                hash.images.push(self.data.story.image);
            }
            $.each(self.data.chapterImages, function (index, chapterImage) {
                if (chapterImage.chapterId === chapter.id) {
                    hash.images.push(chapterImage.image);
                }
            });
            if (hash.images.length === 0) {
                hash.images.push(self.data.story.image);
            }
            self.chapters.array.push(hash);
            self.chapters.hash[chapter.id] = index;
        });
        self.currentChapterIndex = 0;
        self.currentImageIndex = 0;

        self.text = self.element.find('.echo-s-b-text');
        self.element.find('.echo-s-h-t-t').html(self.data.story.title);
        self.element.find('.echo-s-h-i-i').attr("src", self.data.story.image.sizedUrl);
        self.userNode = self.element.find('.echo-s-h-t-n');
        var userLink = '<a class="echo-s-h-t-n-u" target="_blank" href="' + Echoed.Urls.Site + '#user/' + self.data.echoedUser.id + '">' + self.data.echoedUser.name + '</a>';
        var userImage = $('<img />').attr("src", Echoed.getProfilePhotoUrl(self.data.echoedUser)).addClass("echo-s-h-t-n-i").attr("align", "absmiddle");
        self.userNode.append(userImage);
        if(Echoed.echoedUser !== undefined){
            if(self.data.echoedUser.id === Echoed.echoedUser.id){
                var header = self.element.find('.echo-story-header');
                $('<a class="story-edit-button"></a></span>').html('Edit Story').attr("target","_blank").attr("href",Echoed.Urls.Api + "#write/story/" + self.data.story.id).appendTo(header);
            }
        }
        self.userNode.append("by " + userLink);
        self.galleryNode = $("#echo-story-gallery");

        self.itemNode = $("<div class='echo-s-b-item'></div>");
        self.itemImageContainer = $("<div class='echo-s-b-i-c'></div>");
        self.gallery = self.element.find('.echo-s-b-gallery');

        self.img = $("<img />");
        self.itemNode.append(self.itemImageContainer.append(self.img)).appendTo(self.gallery);
        self.thumbnailContainer = $("<div class='echo-s-b-thumbnails'></div>").appendTo(self.gallery);

        var chapterTitle = $("<div class='echo-s-b-t-t'></div>").append(self.data.chapters[0].title);
        var chapterText = $("<div class='echo-s-b-t-b'></div>").append(self.data.chapters[0].text.replace(/\n/g, '<br />'));
        self.text.append(chapterTitle).append(chapterText);

        self.renderGalleryNav();
        self.renderComments();
        self.renderChapter();

        self.EvAg.trigger('fade/show');
        self.element.fadeIn();
    },
    renderGalleryNav:function () {
        var self = this;
        self.thumbnails = {};
        self.titles = [];
        self.galleryChapters = [];
        $.each(self.chapters.array, function (index, chapter) {
            self.galleryChapters[index] = $('<div></div>').addClass('echo-gallery-chapter');
            var title = $('<div></div>').addClass('echo-gallery-title').html(chapter.chapter.title);
            self.galleryChapters[index].append(title);
            self.galleryNode.append(self.galleryChapters[index]);
            $.each(chapter.images, function (index2, image) {
                var thumbNailHash = index + "-" + index2;
                self.thumbnails[thumbNailHash] = $('<img />').addClass("echo-s-b-thumbnail").attr("index", thumbNailHash).attr("src", image.preferredUrl).css(Echoed.getImageSizing(image, 90));
                self.galleryChapters[index].append(self.thumbnails[thumbNailHash]);
            });
        });
    },
    nextImage:function () {
        var self = this;
        self.currentImageIndex++;
        if (self.currentImageIndex >= self.chapters.array[self.currentChapterIndex].images.length) {
            self.nextChapter();
        } else {
            self.renderImage(self.currentImageIndex);
        }
    },
    nextChapter:function () {
        var self = this;
        self.currentChapterIndex++;
        self.currentImageIndex = 0;
        if (self.currentChapterIndex >= self.chapters.array.length) {
            self.currentChapterIndex = 0;
        }
        self.renderChapter(self.currentChapterIndex);
    },
    imageClick:function (e) {
        var self = this;
        var index = $(e.target).attr("index");
        self.currentChapterIndex = index.split("-")[0];
        self.currentImageIndex = index.split("-")[1];
        self.renderChapter();
    },
    renderChapter:function () {
        var self = this;
        var textArea = self.element.find('.echo-s-b-text');
        textArea.fadeOut(function () {
            self.element.find('.echo-s-b-t-t').html(self.chapters.array[self.currentChapterIndex].chapter.title);
            self.element.find('.echo-s-b-t-b').html('"' + self.chapters.array[self.currentChapterIndex].chapter.text.replace(/\n/g, '<br />') + '"');
            textArea.fadeIn();
        });
        self.galleryNode.find('.echo-gallery-chapter').removeClass("highlight");
        self.galleryChapters[self.currentChapterIndex].addClass("highlight");
        self.renderImage();
    },
    renderImage:function () {
        var self = this;
        var currentImage = self.chapters.array[self.currentChapterIndex].images[self.currentImageIndex];
        self.img.fadeOut();
        self.itemImageContainer.animate(Echoed.getImageSizing(currentImage, 400), function () {
            if (currentImage.storyUrl !== null) {
                self.img.attr('src', currentImage.storyUrl);
            } else {
                self.img.attr('src', currentImage.originalUrl);
            }

            self.img.fadeIn();
        });

        self.galleryNode.find('.echo-s-b-thumbnail').removeClass("highlight");
        self.thumbnails[self.currentChapterIndex + "-" + self.currentImageIndex].addClass("highlight");
    },
    renderComments:function () {
        var self = this;
        var commentListNode = self.element.find('.echo-s-c-l');
        var comments = {
            children:[]
        };
        $.each(self.data.comments, function (index, comment) {
            var parentId = comment.parentCommentId;
            if (parentId == null) {
                comments.children.push(comment);
            } else {
                if (comments[parentId] == null) {
                    comments[parentId] = {
                        children:[]
                    }
                }
                comments[parentId].children.push(comment);
            }
        });
        commentListNode.empty();
        $("#echo-story-comment-ta").val("");
        if (self.data.comments.length > 0) $("#echo-s-c-t-count").html("(" + self.data.comments.length + ")");
        $.each(self.data.comments, function (index, comment) {

            var elapsedString = Echoed.timeElapsedString(Echoed.timeStampStringToDate(comment.createdOn.toString()));
            var elapsedNode = $('<span class="echo-s-c-l-c-d"></span>').append(elapsedString);
            var img = $('<img class="echo-s-c-l-c-u-i" />').attr("src", Echoed.getProfilePhotoUrl(comment.echoedUser)).attr("align", "absmiddle");
            var commentUserNode = $('<div class="echo-s-c-l-c-u"></div>').append($("<a></a>").append(comment.echoedUser.name).attr("href", Echoed.Urls.Site + "#user/" + comment.echoedUser.id).attr("target", "_blank")).append(elapsedNode);
            img.prependTo(commentUserNode);
            var commentText = $('<div class="echo-s-c-l-c-t"></div>').append(comment.text);
            var commentNode = $('<div class="echo-s-c-l-c"></div>').append(commentUserNode).append(commentText);
            commentListNode.prepend(commentNode);
        });
        if (Echoed.echoedUser.id || Echoed.echoedUser.name) {
            self.element.find('.comment-submit').fadeIn();
        } else {
            self.element.find('.comment-submit').hide();
            var template = '<div class="comment-login">' +
                    '<div class="comment-login-title">Login to Discuss</div>' +
                    '<img class="login-button comment-login-fb" src="{{urls.images}}/btn_facebook_login.png">' +
                    '<img class="comment-login-tw login-button" src="{{urls.images}}/btn_twitter_login.png">' +
                    '</div>';
            self.element.find('.echo-s-c-tb').append(template);
            self.element.find('.comment-login-fb').attr("href", Echoed.getFacebookLoginUrl("redirect/close"));
            self.element.find('.comment-login-tw').attr("href", Echoed.getTwitterLoginUrl("redirect/close"));
        }
    },
    commentLogin:function (ev) {
        var href = $(ev.currentTarget).attr("href");
        var child = window.open("about:blank", "Echoed", 'width=800,height=440,toolbar=0,menubar=0,location=0,status=1,scrollbars=0,resizable=0,left=0,top=0');
        child.location = href;
    },
    createComment:function () {
        var self = this;
        var storyId = self.data.story.id;
        var chapterId = self.data.chapters[0].id;
        var text = $("#echo-story-comment-ta").val();
        if (text === "") {
            alert("Please enter in a comment");
        } else if (self.locked !== true) {
            self.locked = true;
            $.ajax({
                url:Echoed.Urls.Api + "/story/" + storyId + "/chapter/" + chapterId + "/comment",
                type:"POST",
                xhrFields:{
                    withCredentials:true
                },
                dataType:'json',
                data:{
                    text:text
                },
                success:function (createCommentData) {
                    self.locked = false;
                    self.data.comments.unshift(createCommentData);
                    self.renderComments();
                }
            });
        }
    },
    close:function () {
        var self = this;
        self.EvAg.trigger("exhibit/show");
        self.element.fadeOut();

    },
    click:function () {
        var self = this;
        self.currentImageNum = self.currentImageNum + 1;
        if (self.currentImageNum >= self.data.chapterImages.length) {
            self.currentImageNum = 0;
        }
        self.renderChapterImage();
        if (self.data.chapterImages[self.currentImageNum].chapterId != self.currentChapterId) {
            self.currentChapterNum = self.currentChapterNum + 1;
            if (self.currentChapterNum >= self.data.chapters.length) {
                self.currentChapterNum = 0;
            }
            self.renderChapter();
        }
    }
});

Echoed.Views.Components.MessageHandler = Backbone.View.extend({
    initialize:function (options) {
        _.bindAll(this, 'receiveMessageResponse');
        this.EvAg = options.EvAg;
        if (window.addEventListener) {
            window.addEventListener('message', this.receiveMessageResponse, false);
        } else if (window.attachEvent) {
            window.attachEvent('onmessage', this.receiveMessageResponse);
        }
    },
    receiveMessageResponse:function (response) {
        Echoed.echoedUser = JSON.parse(response.data);
        this.EvAg.trigger('user/login');
    }
});

var EventAggregator = _.extend({}, Backbone.Events);

$(document).ready(function () {
    Echoed.init({
        partnerId:"{{partnerId}}",
        echoedUser:{
            id:"{{echoedUserId}}"
        }
    });
    EventAggregator.trigger('exhibit/open');
});

</script>